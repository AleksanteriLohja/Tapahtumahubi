name: Release (MSIX)

on:
  push:
    tags:
      - 'v*.*.*'   # esim. v1.0.0

permissions:
  contents: write

jobs:
  build-msix:
    runs-on: windows-latest

    # Yleiset ympäristömuuttujat (lintteri näkee nämä)
    env:
      APP_NAME: Tapahtumahubi.App
      APP_VERSION: ${{ github.ref_name }}          # esim. v1.0.0
      CONFIG: Release
      FWF: net8.0-windows10.0.19041.0
      RID: win10-x64
      ARTIFACTS_DIR: ${{ github.workspace }}\artifacts

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install MAUI workload
        shell: pwsh
        run: |
          dotnet workload install maui
          dotnet --info

      - name: Restore
        shell: pwsh
        run: dotnet restore .\Tapahtumahubi.sln

      - name: Publish Windows MSIX
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$Env:ARTIFACTS_DIR" -Force | Out-Null
          dotnet publish ".\src\Tapahtumahubi.App\Tapahtumahubi.App.csproj" `
            -c "$Env:CONFIG" -f "$Env:FWF" `
            -p:WindowsPackageType=MSIX -p:GenerateAppxPackageOnBuild=true `
            -p:AppxPackageSigningEnabled=false -p:UapAppxPackageBuildMode=SideloadOnly `
            -p:Platform=x64 -p:AppxPackageDir="$Env:ARTIFACTS_DIR\"

      - name: Locate outputs and zip dependencies
        id: out
        shell: pwsh
        run: |
          $msix = Get-ChildItem "$Env:ARTIFACTS_DIR" -Recurse -Filter *.msix | Select-Object -First 1 -Expand FullName
          if (-not $msix) { throw "MSIX not found under $Env:ARTIFACTS_DIR" }

          $deps = Get-ChildItem "$Env:ARTIFACTS_DIR" -Recurse -Filter Microsoft.WindowsAppRuntime.*.msix | ForEach-Object { $_.FullName }
          $zip  = Join-Path "$Env:ARTIFACTS_DIR" "$Env:APP_NAME-$Env:APP_VERSION-x64+deps.zip"

          echo "MSIX=$msix" >> $env:GITHUB_OUTPUT
          echo "ZIP=$zip"   >> $env:GITHUB_OUTPUT

          if ($deps) {
            Compress-Archive -Path $msix,$deps -DestinationPath $zip -Force
          } else {
            # Ei riippuvuuksia – zipataan ainakin msix
            Compress-Archive -Path $msix -DestinationPath $zip -Force
          }

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-msix"
          path: ${{ steps.out.outputs.MSIX }}

      - name: Upload ZIP (msix + deps)
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-x64+deps"
          path: ${{ steps.out.outputs.ZIP }}

      - name: Create GitHub Release and attach files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.APP_VERSION }}
          name: "Tapahtumahubi ${{ env.APP_VERSION }}"
          draft: false
          prerelease: false
          files: |
            ${{ steps.out.outputs.MSIX }}
            ${{ steps.out.outputs.ZIP }}
